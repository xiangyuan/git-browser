<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ repo_name }} - Diff</title>
    <link rel="stylesheet" href="/statics/style.css?v=8">
    <script src="/statics/app.js?v=10" defer></script>
    <script src="/statics/htmx.min.js"></script>
    <script src="/statics/json-enc.js"></script>
</head>
<body data-repo-name="{{ repo_name }}">
    <header>
        <h1><a href="/">index</a> : {{ repo_name }}</h1>
    </header>
    
    <nav>
        <a href="/{{ repo_name }}/summary">summary</a>
        <a href="/{{ repo_name }}/log">log</a>
        <a href="/{{ repo_name }}/commit">commit</a>
    </nav>
    <main>
    <div class="sticky-header-group">
        <!-- Global Branch Comparison Selector -->
        <div class="branch-selector-toolbar">
            <form method="get" class="branch-selector-form">
                <span class="branch-selector-label">üîÄ Compare branches:</span>
                <select id="from-branch" name="o" class="branch-selector-select">
                    {% for branch in branches %}
                    <option value="{{ branch }}" {% if branch.as_str() == from_branch %}selected{% endif %}>{{ branch }}</option>
                    {% endfor %}
                </select>
                <span class="branch-selector-arrow">‚Üí</span>
                <select id="to-branch" name="n" class="branch-selector-select">
                    {% for branch in branches %}
                    <option value="{{ branch }}" {% if branch.as_str() == to_branch %}selected{% endif %}>{{ branch }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn-compare">Compare</button>
                <a href="?o={{ to_branch }}&n={{ from_branch }}" class="btn-swap" style="text-decoration: none; display: inline-block; text-align: center;">‚áÑ Swap</a>
            </form>
        </div>
        {% if !commits.is_empty() %}
        <div class="diff-actions">
            <span>Found <strong>{{ commits.len() }}</strong> commits <span id="cherry-picked-count" class="cherry-picked-count"></span></span>
            <div style="display: flex; gap: 8px;">
                <button onclick="syncRepository()" id="sync-btn" class="btn-sync" title="Refresh index from git">
                    üîÑ Sync
                </button>
                <button onclick="cherryPickSelected()" id="cherry-pick-btn" class="btn-cherry-pick">
                    üçí Cherry-pick Selected
                </button>
                <button onclick="pushChanges()" id="push-btn" class="btn-push" style="display: none;">
                    ‚Üë Push to Remote
                </button>
            </div>
        </div>
        {% endif %}
    </div>
        <h2>Branch Comparison: {{ from_branch }} ‚Üí {{ to_branch }}</h2>
        <p class="comparison-desc">
            <em>Showing commits in <code>{{ from_branch }}</code> that are NOT in <code>{{ to_branch }}</code></em>
        </p>
        
        {% if commits.is_empty() %}
        <p class="no-diff-msg">
            ‚úì No new commits in {{ to_branch }} - branches are in sync or {{ from_branch }} is ahead
        </p>
        {% else %}
        <div id="status-message" class="hidden"></div>
        <form id="commits-form">
        <table class="repositories">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                    <th>Time</th>
                    <th>Message</th>
                    <th>Author</th>
                    <th>Hash</th>
                </tr>
            </thead>
            <tbody>
                {% for commit in commits %}
                <tr{% if commit.is_empty %} class="empty-commit" title="This commit has already been cherry-picked (empty diff)"{% endif %}>
                    <td>
                        {% if commit.is_empty %}
                        <input type="checkbox" name="commits" class="commit-checkbox" value="{{ commit.sha }}" disabled title="Already cherry-picked">
                        {% else %}
                        <input type="checkbox" name="commits" class="commit-checkbox" value="{{ commit.sha }}">
                        {% endif %}
                    </td>
                    <td class="timeago" datetime="{{ commit.committer_time }}">{{ commit.committer_time }}</td>
                    <td>
                        {% if commit.is_empty %}<span class="empty-tag" title="Already cherry-picked">‚äò</span> {% endif %}
                        <a href="/{{ repo_name }}/commit?id={{ commit.sha }}">{{ commit.summary }}</a>
                    </td>
                    <td>{{ commit.author_name }}</td>
                    <td><a href="/{{ repo_name }}/commit?id={{ commit.sha }}">{{ commit.sha_short }}</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </form>
        {% endif %}
    </main>
</body>
</html>
